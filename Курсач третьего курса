from flask import Flask, render_template, request, redirect, url_for, flash, jsonify
from flask_login import LoginManager, login_user, logout_user, login_required, current_user
from werkzeug.security import generate_password_hash, check_password_hash
from models import db, User, Product, Category, CartItem
from datetime import datetime
import os

app = Flask(__name__)
app.config['SECRET_KEY'] = 'belaz-parts-secret-key-2024'
app.config['SQLALCHEMY_DATABASE_URI'] = 'postgresql://postgres:Enatan2023@localhost/belaz_parts_db'
app.config['SQLALCHEMY_TRACK_MODIFICATIONS'] = False

db.init_app(app)

login_manager = LoginManager()
login_manager.init_app(app)
login_manager.login_view = 'login'
login_manager.login_message = '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–æ–π–¥–∏—Ç–µ –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ —ç—Ç–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ.'
login_manager.login_message_category = 'info'

@login_manager.user_loader
def load_user(user_id):
    return User.query.get(int(user_id))

@app.route('/')
def index():
    category_id = request.args.get('category_id', type=int)
    sort_by = request.args.get('sort_by', 'name')
    search = request.args.get('search', '')
    
    query = Product.query
    
    if category_id:
        query = query.filter_by(category_id=category_id)
    
    if search:
        query = query.filter(Product.name.ilike(f'%{search}%'))
    
    if sort_by == 'price_asc':
        query = query.order_by(Product.price.asc())
    elif sort_by == 'price_desc':
        query = query.order_by(Product.price.desc())
    elif sort_by == 'name':
        query = query.order_by(Product.name.asc())
    elif sort_by == 'newest':
        query = query.order_by(Product.created_at.desc())
    
    products = query.all()
    categories = Category.query.all()
    
    return render_template('index.html', 
                         products=products, 
                         categories=categories,
                         current_category=category_id,
                         sort_by=sort_by,
                         search=search)

@app.route('/product/<int:product_id>')
def product_detail(product_id):
    product = Product.query.get_or_404(product_id)
    return render_template('product.html', product=product)

@app.route('/register', methods=['GET', 'POST'])
def register():
    if current_user.is_authenticated:
        return redirect(url_for('index'))
        
    if request.method == 'POST':
        username = request.form['username']
        email = request.form['email']
        password = request.form['password']
        confirm_password = request.form['confirm_password']
        
        errors = []
        
        if len(username) < 3 or len(username) > 80:
            errors.append('–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –æ—Ç 3 –¥–æ 80 —Å–∏–º–≤–æ–ª–æ–≤')
            
        if len(password) < 6:
            errors.append('–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –º–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤')
            
        if password != confirm_password:
            errors.append('–ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç')
        
        if User.query.filter_by(username=username).first():
            errors.append('–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —É–∂–µ –∑–∞–Ω—è—Ç–æ')
        
        if User.query.filter_by(email=email).first():
            errors.append('Email —É–∂–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω')
            
        if errors:
            for error in errors:
                flash(error, 'danger')
            return redirect(url_for('register'))
        
        hashed_password = generate_password_hash(password)
        user = User(username=username, email=email, password=hashed_password)
        
        db.session.add(user)
        db.session.commit()
        
        login_user(user)
        flash(f'–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞! –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, {username}!', 'success')
        return redirect(url_for('index'))
    
    return render_template('register.html')

@app.route('/login', methods=['GET', 'POST'])
def login():
    if current_user.is_authenticated:
        return redirect(url_for('index'))
        
    if request.method == 'POST':
        username = request.form['username']
        password = request.form['password']
        user = User.query.filter_by(username=username).first()
        
        if user and check_password_hash(user.password, password):
            login_user(user)
            next_page = request.args.get('next')
            
            if user.is_admin:
                flash(f'–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä {username}!', 'success')
                return redirect(next_page or url_for('admin'))
            else:
                flash(f'–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, {username}!', 'success')
                return redirect(next_page or url_for('index'))
        else:
            flash('–ù–µ–≤–µ—Ä–Ω–æ–µ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–ª–∏ –ø–∞—Ä–æ–ª—å', 'danger')
    
    return render_template('login.html')

@app.route('/logout')
@login_required
def logout():
    username = current_user.username
    logout_user()
    flash(f'–í—ã —É—Å–ø–µ—à–Ω–æ –≤—ã—à–ª–∏ –∏–∑ —Å–∏—Å—Ç–µ–º—ã. –î–æ —Å–≤–∏–¥–∞–Ω–∏—è, {username}!', 'info')
    return redirect(url_for('index'))

@app.route('/add_to_cart/<int:product_id>')
@login_required
def add_to_cart(product_id):
    """–î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞ –≤ –∫–æ—Ä–∑–∏–Ω—É"""
    try:
        product = Product.query.get_or_404(product_id)
        
        if product.stock <= 0:
            flash('–≠—Ç–æ—Ç —Ç–æ–≤–∞—Ä –≤—Ä–µ–º–µ–Ω–Ω–æ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –Ω–∞ —Å–∫–ª–∞–¥–µ', 'warning')
            return redirect(request.referrer or url_for('index'))
        
        cart_item = CartItem.query.filter_by(
            user_id=current_user.id, 
            product_id=product_id
        ).first()
        
        if cart_item:
            if cart_item.quantity >= product.stock:
                flash('–ù–µ–ª—å–∑—è –¥–æ–±–∞–≤–∏—Ç—å –±–æ–ª—å—à–µ —Ç–æ–≤–∞—Ä–∞, —á–µ–º –µ—Å—Ç—å –≤ –Ω–∞–ª–∏—á–∏–∏', 'warning')
                return redirect(request.referrer or url_for('index'))
            cart_item.quantity += 1
        else:
            cart_item = CartItem(
                user_id=current_user.id, 
                product_id=product_id,
                quantity=1
            )
            db.session.add(cart_item)
        
        db.session.commit()
        flash(f'"{product.name}" –¥–æ–±–∞–≤–ª–µ–Ω –≤ –∫–æ—Ä–∑–∏–Ω—É! üõí', 'success')
        
    except Exception as e:
        db.session.rollback()
        flash('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ —Ç–æ–≤–∞—Ä–∞ –≤ –∫–æ—Ä–∑–∏–Ω—É', 'danger')
        print(f"Error adding to cart: {e}")
    
    return redirect(request.referrer or url_for('index'))

@app.route('/cart')
@login_required
def cart():
    """–°—Ç—Ä–∞–Ω–∏—Ü–∞ –∫–æ—Ä–∑–∏–Ω—ã"""
    try:
        # –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ —Ç–æ–≤–∞—Ä—ã –≤ –∫–æ—Ä–∑–∏–Ω–µ —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        cart_items = CartItem.query.filter_by(user_id=current_user.id).all()
        
        total = sum(item.product.price * item.quantity for item in cart_items)
        
        return render_template('cart.html', 
                             cart_items=cart_items, 
                             total=total,
                             cart_count=len(cart_items))
                             
    except Exception as e:
        flash('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∫–æ—Ä–∑–∏–Ω—ã', 'danger')
        print(f"Error loading cart: {e}")
        return render_template('cart.html', cart_items=[], total=0, cart_count=0)

@app.route('/remove_from_cart/<int:cart_item_id>')
@login_required
def remove_from_cart(cart_item_id):
    """–£–¥–∞–ª–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞ –∏–∑ –∫–æ—Ä–∑–∏–Ω—ã"""
    try:
        cart_item = CartItem.query.get_or_404(cart_item_id)
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ç–æ–≤–∞—Ä –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∏—Ç —Ç–µ–∫—É—â–µ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
        if cart_item.user_id != current_user.id:
            flash('–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω', 'danger')
            return redirect(url_for('cart'))
        
        product_name = cart_item.product.name
        db.session.delete(cart_item)
        db.session.commit()
        
        flash(f'"{product_name}" —É–¥–∞–ª–µ–Ω –∏–∑ –∫–æ—Ä–∑–∏–Ω—ã', 'info')
        
    except Exception as e:
        db.session.rollback()
        flash('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Ç–æ–≤–∞—Ä–∞ –∏–∑ –∫–æ—Ä–∑–∏–Ω—ã', 'danger')
        print(f"Error removing from cart: {e}")
    
    return redirect(url_for('cart'))

@app.route('/update_cart_quantity/<int:cart_item_id>', methods=['POST'])
@login_required
def update_cart_quantity(cart_item_id):
    """–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Ç–æ–≤–∞—Ä–∞ –≤ –∫–æ—Ä–∑–∏–Ω–µ (AJAX)"""
    try:
        cart_item = CartItem.query.get_or_404(cart_item_id)
        
        if cart_item.user_id != current_user.id:
            return jsonify({'success': False, 'error': '–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω'})
        
        new_quantity = request.json.get('quantity', 1)
        
        # –ï—Å–ª–∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –º–µ–Ω—å—à–µ 1, —É–¥–∞–ª—è–µ–º —Ç–æ–≤–∞—Ä –∏–∑ –∫–æ—Ä–∑–∏–Ω—ã
        if new_quantity < 1:
            db.session.delete(cart_item)
            db.session.commit()
            return jsonify({
                'success': True, 
                'removed': True,
                'message': '–¢–æ–≤–∞—Ä —É–¥–∞–ª–µ–Ω –∏–∑ –∫–æ—Ä–∑–∏–Ω—ã'
            })
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –Ω–µ –ø—Ä–µ–≤—ã—à–∞–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ
        if new_quantity > cart_item.product.stock:
            return jsonify({
                'success': False, 
                'error': f'–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Ç–æ–≤–∞—Ä–∞ –Ω–∞ —Å–∫–ª–∞–¥–µ. –î–æ—Å—Ç—É–ø–Ω–æ: {cart_item.product.stock} —à—Ç.'
            })
        
        # –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ
        cart_item.quantity = new_quantity
        db.session.commit()
        
        # –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º –æ–±—â—É—é —Å—Ç–æ–∏–º–æ—Å—Ç—å
        cart_items = CartItem.query.filter_by(user_id=current_user.id).all()
        total = sum(item.product.price * item.quantity for item in cart_items)
        item_total = cart_item.product.price * cart_item.quantity
        
        return jsonify({
            'success': True, 
            'item_total': item_total,
            'total': total,
            'quantity': cart_item.quantity
        })
        
    except Exception as e:
        db.session.rollback()
        return jsonify({'success': False, 'error': '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞'})

@app.route('/clear_cart')
@login_required
def clear_cart():
    """–û—á–∏—Å—Ç–∫–∞ –≤—Å–µ–π –∫–æ—Ä–∑–∏–Ω—ã"""
    try:
        # –£–¥–∞–ª—è–µ–º –≤—Å–µ —Ç–æ–≤–∞—Ä—ã —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ –∫–æ—Ä–∑–∏–Ω—ã
        deleted_count = CartItem.query.filter_by(user_id=current_user.id).delete()
        db.session.commit()
        
        flash(f'–ö–æ—Ä–∑–∏–Ω–∞ –æ—á–∏—â–µ–Ω–∞. –£–¥–∞–ª–µ–Ω–æ —Ç–æ–≤–∞—Ä–æ–≤: {deleted_count}', 'info')
        
    except Exception as e:
        db.session.rollback()
        flash('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ—á–∏—Å—Ç–∫–µ –∫–æ—Ä–∑–∏–Ω—ã', 'danger')
        print(f"Error clearing cart: {e}")
    
    return redirect(url_for('cart'))

@app.route('/admin')
@login_required
def admin():
    if not current_user.is_admin:
        flash('–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω. –¢—Ä–µ–±—É—é—Ç—Å—è –ø—Ä–∞–≤–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞.', 'danger')
        return redirect(url_for('index'))
    
    products = Product.query.all()
    categories = Category.query.all()
    users = User.query.all()
    
    stats = {
        'total_products': len(products),
        'total_categories': len(categories),
        'total_users': len(users),
        'low_stock_products': Product.query.filter(Product.stock < 10).count()
    }
    
    return render_template('admin.html', 
                         products=products, 
                         categories=categories,
                         users=users,
                         stats=stats)

@app.route('/admin/add_product', methods=['POST'])
@login_required
def add_product():
    if not current_user.is_admin:
        flash('–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω. –¢—Ä–µ–±—É—é—Ç—Å—è –ø—Ä–∞–≤–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞.', 'danger')
        return redirect(url_for('index'))
    
    try:
        name = request.form['name']
        description = request.form['description']
        price = float(request.form['price'])
        stock = int(request.form['stock'])
        category_id = int(request.form['category_id'])
        part_number = request.form['part_number']
        image_url = request.form.get('image_url', '')
        
        if Product.query.filter_by(part_number=part_number).first():
            flash('–¢–æ–≤–∞—Ä —Å —Ç–∞–∫–∏–º –∞—Ä—Ç–∏–∫—É–ª–æ–º —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç', 'warning')
            return redirect(url_for('admin'))
        
        product = Product(
            name=name,
            description=description,
            price=price,
            stock=stock,
            category_id=category_id,
            part_number=part_number,
            image_url=image_url
        )
        
        db.session.add(product)
        db.session.commit()
        
        flash(f'–¢–æ–≤–∞—Ä "{name}" —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω!', 'success')
        
    except Exception as e:
        flash(f'–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ —Ç–æ–≤–∞—Ä–∞: {str(e)}', 'danger')
    
    return redirect(url_for('admin'))

@app.route('/admin/edit_product/<int:product_id>', methods=['POST'])
@login_required
def edit_product(product_id):
    if not current_user.is_admin:
        flash('–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω. –¢—Ä–µ–±—É—é—Ç—Å—è –ø—Ä–∞–≤–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞.', 'danger')
        return redirect(url_for('index'))
    
    product = Product.query.get_or_404(product_id)
    
    try:
        product.name = request.form['name']
        product.description = request.form['description']
        product.price = float(request.form['price'])
        product.stock = int(request.form['stock'])
        product.category_id = int(request.form['category_id'])
        product.part_number = request.form['part_number']
        product.image_url = request.form.get('image_url', '')
        
        db.session.commit()
        flash(f'–¢–æ–≤–∞—Ä "{product.name}" —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω!', 'success')
        
    except Exception as e:
        flash(f'–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Ç–æ–≤–∞—Ä–∞: {str(e)}', 'danger')
    
    return redirect(url_for('admin'))

@app.route('/admin/delete_product/<int:product_id>')
@login_required
def delete_product(product_id):
    if not current_user.is_admin:
        flash('–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω. –¢—Ä–µ–±—É—é—Ç—Å—è –ø—Ä–∞–≤–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞.', 'danger')
        return redirect(url_for('index'))
    
    product = Product.query.get_or_404(product_id)
    product_name = product.name
    
    # –£–¥–∞–ª—è–µ–º —Å–≤—è–∑–∞–Ω–Ω—ã–µ –∑–∞–ø–∏—Å–∏ –≤ –∫–æ—Ä–∑–∏–Ω–µ
    CartItem.query.filter_by(product_id=product_id).delete()
    
    db.session.delete(product)
    db.session.commit()
    
    flash(f'–¢–æ–≤–∞—Ä "{product_name}" —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω!', 'success')
    return redirect(url_for('admin'))

@app.route('/admin/add_category', methods=['POST'])
@login_required
def add_category():
    if not current_user.is_admin:
        flash('–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω. –¢—Ä–µ–±—É—é—Ç—Å—è –ø—Ä–∞–≤–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞.', 'danger')
        return redirect(url_for('index'))
    
    name = request.form['name']
    description = request.form['description']
    
    if Category.query.filter_by(name=name).first():
        flash('–ö–∞—Ç–µ–≥–æ—Ä–∏—è —Å —Ç–∞–∫–∏–º –Ω–∞–∑–≤–∞–Ω–∏–µ–º —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç', 'warning')
        return redirect(url_for('admin'))
    
    category = Category(name=name, description=description)
    db.session.add(category)
    db.session.commit()
    
    flash(f'–ö–∞—Ç–µ–≥–æ—Ä–∏—è "{name}" —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–∞!', 'success')
    return redirect(url_for('admin'))

@app.route('/admin/delete_category/<int:category_id>')
@login_required
def delete_category(category_id):
    if not current_user.is_admin:
        flash('–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω. –¢—Ä–µ–±—É—é—Ç—Å—è –ø—Ä–∞–≤–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞.', 'danger')
        return redirect(url_for('index'))
    
    category = Category.query.get_or_404(category_id)
    category_name = category.name
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —Ç–æ–≤–∞—Ä—ã –≤ —ç—Ç–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
    if category.products:
        flash(f'–ù–µ–ª—å–∑—è —É–¥–∞–ª–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é "{category_name}", —Ç–∞–∫ –∫–∞–∫ –≤ –Ω–µ–π –µ—Å—Ç—å —Ç–æ–≤–∞—Ä—ã', 'danger')
        return redirect(url_for('admin'))
    
    db.session.delete(category)
    db.session.commit()
    
    flash(f'–ö–∞—Ç–µ–≥–æ—Ä–∏—è "{category_name}" —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω–∞!', 'success')
    return redirect(url_for('admin'))

@app.route('/profile')
@login_required
def profile():
    user_orders = []  
    return render_template('profile.html', user_orders=user_orders)

@app.route('/search')
def search():
    query = request.args.get('q', '')
    if not query:
        return redirect(url_for('index'))
    
    products = Product.query.filter(
        Product.name.ilike(f'%{query}%') | 
        Product.description.ilike(f'%{query}%') |
        Product.part_number.ilike(f'%{query}%')
    ).all()
    
    categories = Category.query.all()
    
    return render_template('index.html', 
                         products=products, 
                         categories=categories,
                         search=query,
                         search_query=query)

@app.context_processor
def utility_processor():
    def format_price(price):
        return "{:,.2f}".format(price).replace(',', ' ')
    
    def get_cart_count():
        if current_user.is_authenticated:
            return CartItem.query.filter_by(user_id=current_user.id).count()
        return 0
    
    def get_cart_items():
        if current_user.is_authenticated:
            return CartItem.query.filter_by(user_id=current_user.id).all()
        return []
    
    def is_admin():
        return current_user.is_authenticated and current_user.is_admin
    
    return {
        'format_price': format_price,
        'get_cart_count': get_cart_count,
        'get_cart_items': get_cart_items,
        'is_admin': is_admin
    }

@app.errorhandler(404)
def not_found_error(error):
    return render_template('404.html'), 404

@app.errorhandler(500)
def internal_error(error):
    db.session.rollback()
    return render_template('500.html'), 500

@app.errorhandler(403)
def forbidden_error(error):
    return render_template('403.html'), 403

if __name__ == '__main__':
    with app.app_context():
        try:
            db.create_all()
            
            # –°–æ–∑–¥–∞–µ–º –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
            if not User.query.filter_by(username='admin').first():
                admin_user = User(
                    username='admin',
                    email='admin@belaz.by',
                    password=generate_password_hash('admin123'),
                    is_admin=True
                )
                db.session.add(admin_user)
                print(" –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä —Å–æ–∑–¥–∞–Ω: admin / admin123")
            
            # –°–æ–∑–¥–∞–µ–º —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            if not User.query.filter_by(username='user').first():
                test_user = User(
                    username='user',
                    email='user@belaz.by',
                    password=generate_password_hash('user123'),
                    is_admin=False
                )
                db.session.add(test_user)
                print(" –¢–µ—Å—Ç–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–∑–¥–∞–Ω: user / user123")
            
            # –°–æ–∑–¥–∞–µ–º –±–∞–∑–æ–≤—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
            if not Category.query.first():
                categories = [
                    Category(name='–î–≤–∏–≥–∞—Ç–µ–ª—å', description='–ó–∞–ø—á–∞—Å—Ç–∏ –¥–ª—è –¥–≤–∏–≥–∞—Ç–µ–ª—è –ë–ï–õ–ê–ó'),
                    Category(name='–¢—Ä–∞–Ω—Å–º–∏—Å—Å–∏—è', description='–¢—Ä–∞–Ω—Å–º–∏—Å—Å–∏–æ–Ω–Ω—ã–µ –∑–∞–ø—á–∞—Å—Ç–∏'),
                    Category(name='–•–æ–¥–æ–≤–∞—è —á–∞—Å—Ç—å', description='–ó–∞–ø—á–∞—Å—Ç–∏ —Ö–æ–¥–æ–≤–æ–π —á–∞—Å—Ç–∏'),
                    Category(name='–≠–ª–µ–∫—Ç—Ä–∏–∫–∞', description='–≠–ª–µ–∫—Ç—Ä–æ–æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ –∏ –ø—Ä–æ–≤–æ–¥–∫–∞'),
                    Category(name='–§–∏–ª—å—Ç—Ä—ã', description='–§–∏–ª—å—Ç—Ä—ã –∏ –º–∞—Å–ª–∞'),
                    Category(name='–¢–æ—Ä–º–æ–∑–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞', description='–¢–æ—Ä–º–æ–∑–Ω—ã–µ –∫–æ–ª–æ–¥–∫–∏ –∏ –¥–∏—Å–∫–∏'),
                    Category(name='–ì–∏–¥—Ä–∞–≤–ª–∏–∫–∞', description='–ì–∏–¥—Ä–∞–≤–ª–∏—á–µ—Å–∫–∏–µ —Å–∏—Å—Ç–µ–º—ã'),
                    Category(name='–ö–∞–±–∏–Ω–∞', description='–ó–∞–ø—á–∞—Å—Ç–∏ –¥–ª—è –∫–∞–±–∏–Ω—ã –≤–æ–¥–∏—Ç–µ–ª—è'),
                ]
                db.session.add_all(categories)
                print("‚úÖ –ë–∞–∑–æ–≤—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ —Å–æ–∑–¥–∞–Ω—ã")
            
            
            if not Product.query.first():
                engine_category = Category.query.filter_by(name='–î–≤–∏–≥–∞—Ç–µ–ª—å').first()
                brakes_category = Category.query.filter_by(name='–¢–æ—Ä–º–æ–∑–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞').first()
                filters_category = Category.query.filter_by(name='–§–∏–ª—å—Ç—Ä—ã').first()
                transmission_category = Category.query.filter_by(name='–¢—Ä–∞–Ω—Å–º–∏—Å—Å–∏—è').first()
                chassis_category = Category.query.filter_by(name='–•–æ–¥–æ–≤–∞—è —á–∞—Å—Ç—å').first()
                electric_category = Category.query.filter_by(name='–≠–ª–µ–∫—Ç—Ä–∏–∫–∞').first()
                hydraulic_category = Category.query.filter_by(name='–ì–∏–¥—Ä–∞–≤–ª–∏–∫–∞').first()
                cabin_category = Category.query.filter_by(name='–ö–∞–±–∏–Ω–∞').first()
                
                test_products = [
                    Product(
                        name='–§–∏–ª—å—Ç—Ä –º–∞—Å–ª—è–Ω—ã–π –î–í–° –ë–ï–õ–ê–ó-7555',
                        description='–ú–∞—Å–ª—è–Ω—ã–π —Ñ–∏–ª—å—Ç—Ä –¥–ª—è –¥–≤–∏–≥–∞—Ç–µ–ª—è –ë–ï–õ–ê–ó-7555. –û—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å. –í—ã—Å–æ–∫–æ–∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã, –æ–±–µ—Å–ø–µ—á–∏–≤–∞—é—â–∏–µ –Ω–∞–¥–µ–∂–Ω—É—é –∑–∞—â–∏—Ç—É –¥–≤–∏–≥–∞—Ç–µ–ª—è.',
                        price=12500.00,
                        stock=15,
                        category_id=filters_category.id if filters_category else 5,
                        part_number='BEL-FM-7555',
                        image_url='https://via.placeholder.com/400x300?text=–§–∏–ª—å—Ç—Ä+–º–∞—Å–ª—è–Ω—ã–π'
                    ),
                    Product(
                        name='–¢–æ—Ä–º–æ–∑–Ω–∞—è –∫–æ–ª–æ–¥–∫–∞ –ø–µ—Ä–µ–¥–Ω—è—è –ë–ï–õ–ê–ó-75600',
                        description='–¢–æ—Ä–º–æ–∑–Ω–∞—è –∫–æ–ª–æ–¥–∫–∞ –ø–µ—Ä–µ–¥–Ω–µ–≥–æ –º–æ—Å—Ç–∞ –ë–ï–õ–ê–ó-75600. –í—ã—Å–æ–∫–æ–∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω—ã–π –º–∞—Ç–µ—Ä–∏–∞–ª, –æ–±–µ—Å–ø–µ—á–∏–≤–∞—é—â–∏–π –Ω–∞–¥–µ–∂–Ω–æ–µ —Ç–æ—Ä–º–æ–∂–µ–Ω–∏–µ –≤ –ª—é–±—ã—Ö —É—Å–ª–æ–≤–∏—è—Ö.',
                        price=34500.00,
                        stock=8,
                        category_id=brakes_category.id if brakes_category else 6,
                        part_number='BEL-TK-75600',
                        image_url='https://via.placeholder.com/400x300?text=–¢–æ—Ä–º–æ–∑–Ω–∞—è+–∫–æ–ª–æ–¥–∫–∞'
                    ),
                    Product(
                        name='–°–≤–µ—á–∞ –Ω–∞–∫–∞–ª–∏–≤–∞–Ω–∏—è 24V',
                        description='–°–≤–µ—á–∞ –Ω–∞–∫–∞–ª–∏–≤–∞–Ω–∏—è –¥–ª—è –¥–∏–∑–µ–ª—å–Ω–æ–≥–æ –¥–≤–∏–≥–∞—Ç–µ–ª—è. –ù–∞–ø—Ä—è–∂–µ–Ω–∏–µ 24V. –û–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –Ω–∞–¥–µ–∂–Ω—ã–π –∑–∞–ø—É—Å–∫ –¥–≤–∏–≥–∞—Ç–µ–ª—è –≤ —Ö–æ–ª–æ–¥–Ω–æ–µ –≤—Ä–µ–º—è –≥–æ–¥–∞.',
                        price=8500.00,
                        stock=25,
                        category_id=engine_category.id if engine_category else 1,
                        part_number='BEL-SN-240',
                        image_url='https://via.placeholder.com/400x300?text=–°–≤–µ—á–∞+–Ω–∞–∫–∞–ª–∏–≤–∞–Ω–∏—è'
                    ),
                    Product(
                        name='–†–µ–º–µ–Ω—å –ì–†–ú –ë–ï–õ–ê–ó-7525',
                        description='–†–µ–º–µ–Ω—å –≥–∞–∑–æ—Ä–∞—Å–ø—Ä–µ–¥–µ–ª–∏—Ç–µ–ª—å–Ω–æ–≥–æ –º–µ—Ö–∞–Ω–∏–∑–º–∞ –¥–ª—è –ë–ï–õ–ê–ó-7525. –í—ã—Å–æ–∫–∞—è –∏–∑–Ω–æ—Å–æ—Å—Ç–æ–π–∫–æ—Å—Ç—å, –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–µ –∫–∞—á–µ—Å—Ç–≤–æ.',
                        price=28700.00,
                        stock=12,
                        category_id=engine_category.id if engine_category else 1,
                        part_number='BEL-RGM-7525',
                        image_url='https://via.placeholder.com/400x300?text=–†–µ–º–µ–Ω—å+–ì–†–ú'
                    ),
                    Product(
                        name='–¢–æ–ø–ª–∏–≤–Ω—ã–π —Ñ–∏–ª—å—Ç—Ä —Ç–æ–Ω–∫–æ–π –æ—á–∏—Å—Ç–∫–∏',
                        description='–§–∏–ª—å—Ç—Ä —Ç–æ–Ω–∫–æ–π –æ—á–∏—Å—Ç–∫–∏ —Ç–æ–ø–ª–∏–≤–∞. –ó–∞—â–∏—â–∞–µ—Ç —Ç–æ–ø–ª–∏–≤–Ω—É—é —Å–∏—Å—Ç–µ–º—É –æ—Ç –∑–∞–≥—Ä—è–∑–Ω–µ–Ω–∏–π, –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç —Å—Ç–∞–±–∏–ª—å–Ω—É—é —Ä–∞–±–æ—Ç—É –¥–≤–∏–≥–∞—Ç–µ–ª—è.',
                        price=9800.00,
                        stock=30,
                        category_id=filters_category.id if filters_category else 5,
                        part_number='BEL-TF-001',
                        image_url='https://via.placeholder.com/400x300?text=–¢–æ–ø–ª–∏–≤–Ω—ã–π+—Ñ–∏–ª—å—Ç—Ä'
                    ),
                    Product(
                        name='–ê–∫–∫—É–º—É–ª—è—Ç–æ—Ä 190–ê/—á',
                        description='–¢—è–≥–æ–≤—ã–π –∞–∫–∫—É–º—É–ª—è—Ç–æ—Ä –¥–ª—è –∫–∞—Ä—å–µ—Ä–Ω–æ–≥–æ —Å–∞–º–æ—Å–≤–∞–ª–∞. –í—ã—Å–æ–∫–∞—è –µ–º–∫–æ—Å—Ç—å, –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç—å –≤ —ç–∫—Å—Ç—Ä–µ–º–∞–ª—å–Ω—ã—Ö —É—Å–ª–æ–≤–∏—è—Ö.',
                        price=152000.00,
                        stock=4,
                        category_id=electric_category.id if electric_category else 4,
                        part_number='BEL-ACC-190',
                        image_url='https://via.placeholder.com/400x300?text=–ê–∫–∫—É–º—É–ª—è—Ç–æ—Ä'
                    ),
                    Product(
                        name='–ê–º–æ—Ä—Ç–∏–∑–∞—Ç–æ—Ä –ø–µ—Ä–µ–¥–Ω–∏–π',
                        description='–ê–º–æ—Ä—Ç–∏–∑–∞—Ç–æ—Ä –ø–µ—Ä–µ–¥–Ω–µ–π –ø–æ–¥–≤–µ—Å–∫–∏. –û–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –ø–ª–∞–≤–Ω–æ—Å—Ç—å —Ö–æ–¥–∞ –∏ —É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å –∞–≤—Ç–æ–º–æ–±–∏–ª—è.',
                        price=65400.00,
                        stock=6,
                        category_id=chassis_category.id if chassis_category else 3,
                        part_number='BEL-AMP-7560',
                        image_url='https://via.placeholder.com/400x300?text=–ê–º–æ—Ä—Ç–∏–∑–∞—Ç–æ—Ä'
                    ),
                    Product(
                        name='–ì–∏–¥—Ä–æ—Ü–∏–ª–∏–Ω–¥—Ä —Ä—É–ª–µ–≤–æ–≥–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è',
                        description='–û—Å–Ω–æ–≤–Ω–æ–π –≥–∏–¥—Ä–æ—Ü–∏–ª–∏–Ω–¥—Ä —Ä—É–ª–µ–≤–æ–≥–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è. –ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å –∏ –¥–æ–ª–≥–æ–≤–µ—á–Ω–æ—Å—Ç—å –≤ —Ç—è–∂–µ–ª—ã—Ö —É—Å–ª–æ–≤–∏—è—Ö —ç–∫—Å–ø–ª—É–∞—Ç–∞—Ü–∏–∏.',
                        price=189000.00,
                        stock=3,
                        category_id=hydraulic_category.id if hydraulic_category else 7,
                        part_number='BEL-GC-RU',
                        image_url='https://via.placeholder.com/400x300?text=–ì–∏–¥—Ä–æ—Ü–∏–ª–∏–Ω–¥—Ä'
                    )
                ]
                db.session.add_all(test_products)
                print(" –¢–µ—Å—Ç–æ–≤—ã–µ —Ç–æ–≤–∞—Ä—ã —Å–æ–∑–¥–∞–Ω—ã")
            
            db.session.commit()
            print(" –£—Å–ø–µ—à–Ω–æ")
            
        except Exception as e:
            print(f" –û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö: {e}")
            db.session.rollback()
    
    app.run(debug=True, host='0.0.0.0', port=5000)
